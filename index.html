<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MealPrep Pro v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .checked-text { text-decoration: line-through; color: #94a3b8; }
        .meal-card.selected { border-color: #10b981; background-color: #ecfdf5; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 pb-24">

    <header class="bg-white border-b sticky top-0 z-30 p-4 flex justify-between items-center shadow-sm h-16">
        <h1 class="text-xl font-bold text-emerald-600">MealPrep Pro</h1>
        <select id="store-selector" onchange="render()" class="bg-slate-100 border rounded px-2 py-1 text-sm outline-none">
            <option value="Default">Default (Dept)</option>
            <option value="Main Store">My Main Store</option>
        </select>
    </header>

    <main class="p-4 max-w-md mx-auto">
        
        <section id="recipes" class="tab-content active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Recipe Book</h2>
                <button onclick="showModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md shadow-emerald-100 transition-transform active:scale-95">+ Add Recipe</button>
            </div>
            <div id="recipe-list" class="space-y-3 pb-4"></div>
        </section>

        <section id="planner" class="tab-content">
            <h2 class="text-lg font-semibold mb-2 text-slate-700">Select Meals for the Week</h2>
            <p class="text-xs text-slate-400 mb-4">Tap the meals you want to cook.</p>
            
            <div id="planner-list" class="grid grid-cols-1 gap-3 mb-6"></div>
            
            <button onclick="generateList()" class="w-full bg-emerald-600 text-white font-bold text-lg py-4 rounded-xl shadow-lg shadow-emerald-200 active:bg-emerald-700 transition-all flex items-center justify-center gap-2">
                <span>Generate Shopping List</span>
                <span>‚Üí</span>
            </button>
        </section>

        <section id="shopping" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Grocery List</h2>
                <button onclick="resetAll()" class="text-xs font-bold text-red-500 border border-red-200 px-3 py-1 rounded-full bg-red-50">Reset All</button>
            </div>
            
            <div id="empty-msg" class="hidden text-center py-10">
                <p class="text-4xl mb-2">ü•ó</p>
                <p class="text-slate-400">Your list is empty.<br>Go to <b>Plan</b> and select meals!</p>
            </div>

            <div id="grocery-list" class="space-y-5"></div>
            <div id="completed-list" class="mt-8 space-y-2 opacity-60"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-6 shadow-2xl z-20 h-20 items-center">
        <button onclick="switchTab('recipes')" class="flex flex-col items-center p-2 text-slate-400 focus:text-emerald-600 w-16">
            <span class="text-2xl mb-1">üìñ</span>
            <span class="text-[10px] font-bold">Recipes</span>
        </button>
        <button onclick="switchTab('planner')" class="flex flex-col items-center p-2 text-slate-400 focus:text-emerald-600 w-16">
            <span class="text-2xl mb-1">üóìÔ∏è</span>
            <span class="text-[10px] font-bold">Plan</span>
        </button>
        <button onclick="switchTab('shopping')" class="flex flex-col items-center p-2 text-slate-400 focus:text-emerald-600 w-16">
            <span class="text-2xl mb-1">üõí</span>
            <span class="text-[10px] font-bold">Shop</span>
        </button>
    </nav>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-slate-800">New Recipe</h3>
            
            <input id="rec-title" type="text" placeholder="Recipe Name" class="w-full border p-3 rounded-xl mb-4 bg-slate-50 outline-emerald-500 font-medium">
            
            <div class="flex-1 overflow-hidden flex flex-col min-h-0 mb-4">
                <div id="ingredient-inputs" class="space-y-2 overflow-y-auto pr-1"></div>
                <button onclick="addIngredientRow()" class="w-full py-3 text-sm text-emerald-600 border-2 border-dashed border-emerald-100 rounded-xl mt-2 font-bold hover:bg-emerald-50">+ Add Ingredient</button>
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="hideModal()" class="flex-1 py-3 text-slate-400 font-medium bg-slate-100 rounded-xl">Cancel</button>
                <button onclick="saveRecipe()" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold shadow-md shadow-emerald-200">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA HANDLING ---
        let recipes = JSON.parse(localStorage.getItem('myRecipes')) || [];
        let storeMaps = JSON.parse(localStorage.getItem('storeMaps')) || {};
        let checkedItems = JSON.parse(localStorage.getItem('checkedItems')) || [];
        // Ensure selectedIds is always a Set of NUMBERS
        let savedIds = JSON.parse(localStorage.getItem('selectedIds')) || [];
        let selectedIds = new Set(savedIds.map(id => Number(id))); 

        const categories = ["Produce", "Meat", "Dairy", "Pantry", "Frozen", "Bakery", "Other"];

        function saveToStorage() {
            localStorage.setItem('myRecipes', JSON.stringify(recipes));
            localStorage.setItem('storeMaps', JSON.stringify(storeMaps));
            localStorage.setItem('checkedItems', JSON.stringify(checkedItems));
            localStorage.setItem('selectedIds', JSON.stringify(Array.from(selectedIds)));
        }

        // --- NAVIGATION & UI ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            render();
            window.scrollTo(0,0);
        }

        function showModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            document.getElementById('rec-title').value = '';
            document.getElementById('ingredient-inputs').innerHTML = '';
            addIngredientRow(); // Default one row
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        // --- CORE LOGIC ---
        function addIngredientRow() {
            const container = document.getElementById('ingredient-inputs');
            const row = document.createElement('div');
            row.className = "flex flex-col gap-1 bg-slate-50 p-2 rounded-lg border border-slate-200";
            row.innerHTML = `
                <input type="text" placeholder="Item Name (e.g. Eggs)" class="ing-name bg-transparent font-medium outline-none text-sm p-1 w-full text-slate-800">
                <div class="flex gap-2">
                    <input type="text" placeholder="Qty (1 doz)" class="ing-note bg-white border border-slate-200 rounded px-2 py-1 text-xs w-1/2 outline-emerald-400 text-slate-600">
                    <select class="ing-cat bg-white border border-slate-200 rounded px-2 py-1 text-xs w-1/2 outline-emerald-400 text-slate-600 h-7">
                        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
            `;
            container.appendChild(row);
            // Auto-focus the new input for speed
            row.querySelector('.ing-name').focus();
        }

        function saveRecipe() {
            const title = document.getElementById('rec-title').value.trim();
            const rows = document.querySelectorAll('#ingredient-inputs > div');
            const ingredients = [];
            
            rows.forEach(row => {
                const name = row.querySelector('.ing-name').value.trim();
                const note = row.querySelector('.ing-note').value.trim();
                const cat = row.querySelector('.ing-cat').value;
                if(name) {
                    ingredients.push({ 
                        id: Math.random().toString(36).substr(2, 9), 
                        name, note, cat 
                    });
                }
            });

            if(!title) return alert("Please give your recipe a name!");
            if(ingredients.length === 0) return alert("Please add at least one ingredient!");
            
            recipes.push({ id: Date.now(), title, ingredients });
            saveToStorage();
            hideModal();
            render();
        }

        function toggleSelection(id) {
            // Convert to number just to be safe
            const numId = Number(id);
            if(selectedIds.has(numId)) {
                selectedIds.delete(numId);
            } else {
                selectedIds.add(numId);
            }
            saveToStorage();
            render();
        }

        // THE NEW BUTTON FUNCTION
        function generateList() {
            if(selectedIds.size === 0) {
                alert("Please select at least one meal first!");
                return;
            }
            switchTab('shopping');
        }

        function toggleCheck(ingredientName) {
            if(checkedItems.includes(ingredientName)) {
                checkedItems = checkedItems.filter(i => i !== ingredientName);
            } else {
                checkedItems.push(ingredientName);
            }
            saveToStorage();
            render();
        }

        function resetAll() {
            if(confirm("Start fresh? This will clear your shopping list and weekly plan.")) {
                checkedItems = [];
                selectedIds.clear();
                saveToStorage();
                render();
            }
        }

        function updateAisle(name, val) {
            const store = document.getElementById('store-selector').value;
            if (store === "Default") return;
            if (!storeMaps[store]) storeMaps[store] = {};
            storeMaps[store][name] = val;
            saveToStorage();
        }

        function deleteRecipe(id) {
            if(confirm("Delete this recipe permanently?")) {
                recipes = recipes.filter(r => r.id !== id);
                // Also remove from selection if it was there
                selectedIds.delete(id);
                saveToStorage();
                render();
            }
        }

        // --- RENDER ENGINE ---
        function render() {
            const currentStore = document.getElementById('store-selector').value;

            // 1. RENDER RECIPES
            const recList = document.getElementById('recipe-list');
            if (recipes.length === 0) {
                recList.innerHTML = `<div class="text-center text-slate-400 py-10">No recipes yet.<br>Tap "+ Add Recipe" to start!</div>`;
            } else {
                recList.innerHTML = recipes.map(r => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm">
                        <div>
                            <span class="font-bold text-slate-800 block">${r.title}</span>
                            <span class="text-xs text-slate-400">${r.ingredients.length} items</span>
                        </div>
                        <button onclick="deleteRecipe(${r.id})" class="text-slate-300 hover:text-red-400 px-2 text-xl">√ó</button>
                    </div>
                `).join('');
            }

            // 2. RENDER PLANNER
            const planList = document.getElementById('planner-list');
            if (recipes.length === 0) {
                planList.innerHTML = `<div class="text-center text-slate-400 py-10">Add recipes first,<br>then plan your week here.</div>`;
            } else {
                planList.innerHTML = recipes.map(r => {
                    const isSelected = selectedIds.has(r.id);
                    return `
                    <div onclick="toggleSelection(${r.id})" 
                         class="meal-card p-4 rounded-2xl border-2 transition-all cursor-pointer flex justify-between items-center ${isSelected ? 'selected' : 'border-white bg-white shadow-sm'}">
                        <span class="${isSelected ? 'font-bold text-emerald-800' : 'text-slate-600'}">${r.title}</span>
                        ${isSelected ? '<span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">‚úì</span>' : '<span class="w-6 h-6 border-2 border-slate-100 rounded-full"></span>'}
                    </div>
                `}).join('');
            }

            // 3. RENDER SHOPPING LIST
            let activeGrouped = {};
            let completedItems = [];
            let hasItems = false;
            
            // Aggregate ingredients from selected recipes
            recipes.filter(r => selectedIds.has(r.id)).forEach(r => {
                r.ingredients.forEach(item => {
                    hasItems = true;
                    // Check if already in 'checked' list
                    if(checkedItems.includes(item.name)) {
                        // Prevent duplicates in completed list
                        if(!completedItems.find(c => c.name === item.name)) {
                            completedItems.push(item);
                        }
                    } else {
                        // Determine Grouping Key (Aisle or Category)
                        const aisle = storeMaps[currentStore]?.[item.name] || '';
                        const groupKey = (currentStore !== "Default" && aisle) ? `Aisle ${aisle}` : item.cat;
                        
                        if(!activeGrouped[groupKey]) activeGrouped[groupKey] = [];
                        
                        // Prevent duplicates in active list (combine notes?)
                        const existing = activeGrouped[groupKey].find(a => a.name === item.name);
                        if(existing) {
                            // Simple combine: "2 eggs, 1 egg"
                            if(item.note) existing.note = existing.note ? `${existing.note}, ${item.note}` : item.note;
                        } else {
                            activeGrouped[groupKey].push({...item, aisle}); // Copy item to avoid mutating original
                        }
                    }
                });
            });

            // Toggle Empty Message
            const emptyMsg = document.getElementById('empty-msg');
            const shopContainer = document.getElementById('grocery-list');
            const doneContainer = document.getElementById('completed-list');

            if (!hasItems) {
                emptyMsg.classList.remove('hidden');
                shopContainer.innerHTML = '';
                doneContainer.innerHTML = '';
                return; 
            } else {
                emptyMsg.classList.add('hidden');
            }

            // Draw Active List
            shopContainer.innerHTML = Object.keys(activeGrouped).sort().map(group => `
                <div class="mb-2">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1 sticky top-16 bg-slate-50 py-1 z-10">${group}</h3>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden divide-y divide-slate-50">
                        ${activeGrouped[group].map(item => `
                            <div class="flex items-center gap-3 p-3 active:bg-slate-50 transition-colors">
                                <div onclick="toggleCheck('${item.name}')" class="cursor-pointer">
                                    <div class="w-6 h-6 rounded-full border-2 border-slate-200 hover:border-emerald-400"></div>
                                </div>
                                <div class="flex-1" onclick="toggleCheck('${item.name}')">
                                    <div class="text-sm font-medium text-slate-800">${item.name}</div>
                                    ${item.note ? `<div class="text-[11px] text-emerald-600 font-medium">${item.note}</div>` : ''}
                                </div>
                                ${currentStore !== "Default" ? 
                                    `<input type="text" placeholder="#" value="${item.aisle}" 
                                            onchange="updateAisle('${item.name}', this.value)" 
                                            class="w-8 bg-slate-50 border rounded text-[10px] p-1 text-center outline-none focus:border-emerald-500 text-slate-400 focus:text-slate-800">` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Draw Completed List
            doneContainer.innerHTML = completedItems.length ? `
                <div class="flex items-center gap-2 justify-center mb-2 mt-6">
                    <div class="h-px bg-slate-200 flex-1"></div>
                    <span class="text-[10px] font-bold text-slate-300 uppercase">Done</span>
                    <div class="h-px bg-slate-200 flex-1"></div>
                </div>
                <div class="bg-slate-100/50 rounded-2xl p-2 space-y-1 border border-slate-100">
                    ${completedItems.map(item => `
                        <div onclick="toggleCheck('${item.name}')" class="flex items-center gap-3 p-2 cursor-pointer">
                            <div class="w-5 h-5 rounded-full bg-emerald-100 text-emerald-500 flex items-center justify-center text-xs">‚úì</div>
                            <span class="text-sm checked-text flex-1">${item.name}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';
        }

        // Init
        window.onload = render;
    </script>
</body>
</html>
