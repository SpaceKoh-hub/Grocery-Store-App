<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MealPrep Pro v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .checked-text { text-decoration: line-through; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 pb-24">

    <header class="bg-white border-b sticky top-0 z-30 p-4 flex justify-between items-center shadow-sm">
        <h1 class="text-xl font-bold text-emerald-600">MealPrep Pro</h1>
        <select id="store-selector" onchange="render()" class="bg-slate-100 border rounded px-2 py-1 text-sm outline-none">
            <option value="Default">Default (Dept)</option>
            <option value="Main Store">My Main Store</option>
        </select>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <section id="recipes" class="tab-content active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Recipe Book</h2>
                <button onclick="showModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md shadow-emerald-100">+ Add Recipe</button>
            </div>
            <div id="recipe-list" class="space-y-2"></div>
        </section>

        <section id="planner" class="tab-content">
            <h2 class="text-lg font-semibold mb-4 text-slate-700">Weekly Plan</h2>
            <div id="planner-list" class="space-y-2"></div>
        </section>

        <section id="shopping" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Grocery List</h2>
                <button onclick="resetAll()" class="text-xs font-bold text-red-500 border border-red-200 px-3 py-1 rounded-full bg-red-50">Reset All</button>
            </div>
            <div id="grocery-list" class="space-y-4"></div>
            <div id="completed-list" class="mt-8 space-y-2 opacity-60"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 pb-8 shadow-2xl z-20">
        <button onclick="switchTab('recipes')" class="flex flex-col items-center text-xs text-slate-400">
            <span class="text-xl mb-1">üìñ</span>Recipes
        </button>
        <button onclick="switchTab('planner')" class="flex flex-col items-center text-xs text-slate-400">
            <span class="text-xl mb-1">üóìÔ∏è</span>Plan
        </button>
        <button onclick="switchTab('shopping')" class="flex flex-col items-center text-xs text-slate-400">
            <span class="text-xl mb-1">üõí</span>Shop
        </button>
    </nav>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-slate-800">New Recipe</h3>
            <input id="rec-title" type="text" placeholder="Recipe Name" class="w-full border p-3 rounded-xl mb-4 bg-slate-50 outline-emerald-500">
            <div class="space-y-2 mb-4">
                <div id="ingredient-inputs" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                <button onclick="addIngredientRow()" class="w-full py-2 text-sm text-emerald-600 border-2 border-dashed border-emerald-100 rounded-xl mt-2">+ Add Item</button>
            </div>
            <div class="flex gap-3">
                <button onclick="hideModal()" class="flex-1 py-3 text-slate-400 font-medium">Cancel</button>
                <button onclick="saveRecipe()" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold">Save Recipe</button>
            </div>
        </div>
    </div>

    <script>
        let recipes = JSON.parse(localStorage.getItem('myRecipes')) || [];
        let storeMaps = JSON.parse(localStorage.getItem('storeMaps')) || {};
        let checkedItems = JSON.parse(localStorage.getItem('checkedItems')) || [];
        let selectedIds = new Set(JSON.parse(localStorage.getItem('selectedIds')) || []);
        const categories = ["Produce", "Meat", "Dairy", "Pantry", "Frozen", "Bakery", "Other"];

        function saveToStorage() {
            localStorage.setItem('myRecipes', JSON.stringify(recipes));
            localStorage.setItem('storeMaps', JSON.stringify(storeMaps));
            localStorage.setItem('checkedItems', JSON.stringify(checkedItems));
            localStorage.setItem('selectedIds', JSON.stringify(Array.from(selectedIds)));
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            render();
        }

        function showModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            document.getElementById('ingredient-inputs').innerHTML = '';
            addIngredientRow();
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        function addIngredientRow() {
            const container = document.getElementById('ingredient-inputs');
            const row = document.createElement('div');
            row.className = "flex flex-col gap-1 bg-slate-50 p-2 rounded-lg border border-slate-100";
            row.innerHTML = `
                <input type="text" placeholder="Item Name" class="ing-name bg-transparent font-medium outline-none text-sm p-1">
                <div class="flex gap-2">
                    <input type="text" placeholder="Note (2 sticks)" class="ing-note bg-white border rounded px-2 py-1 text-xs w-1/2 outline-emerald-400">
                    <select class="ing-cat bg-white border rounded px-2 py-1 text-xs w-1/2 outline-emerald-400">
                        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
            `;
            container.appendChild(row);
        }

        function saveRecipe() {
            const title = document.getElementById('rec-title').value;
            const rows = document.querySelectorAll('#ingredient-inputs > div');
            const ingredients = [];
            rows.forEach(row => {
                const name = row.querySelector('.ing-name').value;
                const note = row.querySelector('.ing-note').value;
                const cat = row.querySelector('.ing-cat').value;
                if(name) ingredients.push({ id: Math.random().toString(36).substr(2, 9), name, note, cat });
            });
            if(!title) return;
            recipes.push({ id: Date.now(), title, ingredients });
            saveToStorage();
            hideModal();
            render();
        }

        function toggleCheck(ingredientName) {
            if(checkedItems.includes(ingredientName)) {
                checkedItems = checkedItems.filter(i => i !== ingredientName);
            } else {
                checkedItems.push(ingredientName);
            }
            saveToStorage();
            render();
        }

        function resetAll() {
            if(confirm("Clear shopping list and plan?")) {
                checkedItems = [];
                selectedIds.clear();
                saveToStorage();
                render();
            }
        }

        function render() {
            const currentStore = document.getElementById('store-selector').value;

            // Recipes
            document.getElementById('recipe-list').innerHTML = recipes.map(r => `
                <div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm">
                    <span class="font-bold text-slate-700">${r.title}</span>
                    <button onclick="recipes=recipes.filter(x=>x.id!=${r.id});saveToStorage();render()" class="text-red-300">‚úï</button>
                </div>
            `).join('');

            // Planner
            document.getElementById('planner-list').innerHTML = recipes.map(r => `
                <div onclick="selectedIds.has(${r.id})?selectedIds.delete(${r.id}):selectedIds.add(${r.id});saveToStorage();render()" 
                     class="p-4 rounded-2xl border-2 transition-all cursor-pointer ${selectedIds.has(r.id) ? 'border-emerald-500 bg-emerald-50' : 'border-white bg-white shadow-sm'}">
                    <span class="${selectedIds.has(r.id) ? 'font-bold text-emerald-700' : 'text-slate-600'}">${r.title}</span>
                </div>
            `).join('');

            // Shopping List Logic
            let activeGrouped = {};
            let completedItems = [];
            
            recipes.filter(r => selectedIds.has(r.id)).forEach(r => {
                r.ingredients.forEach(item => {
                    const aisle = storeMaps[currentStore]?.[item.name] || '';
                    const groupKey = (currentStore !== "Default" && aisle) ? `Aisle ${aisle}` : item.cat;
                    
                    if(checkedItems.includes(item.name)) {
                        if(!completedItems.find(c => c.name === item.name)) completedItems.push(item);
                    } else {
                        if(!activeGrouped[groupKey]) activeGrouped[groupKey] = [];
                        if(!activeGrouped[groupKey].find(a => a.name === item.name)) activeGrouped[groupKey].push({...item, aisle});
                    }
                });
            });

            // Render Active
            document.getElementById('grocery-list').innerHTML = Object.keys(activeGrouped).sort().map(group => `
                <div class="mb-4">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">${group}</h3>
                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden divide-y divide-slate-50">
                        ${activeGrouped[group].map(item => `
                            <div class="flex items-center gap-3 p-3">
                                <input type="checkbox" onchange="toggleCheck('${item.name}')" class="w-6 h-6 rounded-full border-slate-200 text-emerald-500">
                                <div class="flex-1">
                                    <div class="text-sm font-medium">${item.name}</div>
                                    <div class="text-[10px] text-slate-400">${item.note}</div>
                                </div>
                                ${currentStore !== "Default" ? `<input type="text" placeholder="Ail" value="${item.aisle}" onchange="storeMaps['${currentStore}']['${item.name}']=this.value;saveToStorage();render()" class="w-10 bg-slate-50 border rounded text-[10px] p-1 text-center">` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Render Completed
            document.getElementById('completed-list').innerHTML = completedItems.length ? `
                <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-2 px-1 text-center">Completed</h3>
                <div class="bg-slate-100 rounded-2xl p-2 space-y-1">
                    ${completedItems.map(item => `
                        <div onclick="toggleCheck('${item.name}')" class="flex items-center gap-3 p-2">
                            <span class="text-emerald-500 text-sm">‚úì</span>
                            <span class="text-sm checked-text">${item.name}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';
        }
        window.onload = render;
    </script>
</body>
</html>
